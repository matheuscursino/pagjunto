<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard do Parceiro - <% if (typeof partnerData.partnerName !== 'undefined') { %><%= partnerData.partnerName %><% } else { %>PagJunto Corporativo<% } %></title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- Variáveis CSS Modernas --- */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --primary-color: #667eea;
            --primary-dark: #5a67d8;
            --secondary-color: #4c51bf;
            --accent-color: #48bb78;
            --accent-hover: #38a169;
            --danger-color: #f56565;
            --warning-color: #ed8936;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --bg-primary: #f7fafc;
            --bg-secondary: #edf2f7;
            --bg-card: #ffffff;
            --border-light: #e2e8f0;
            --border-medium: #cbd5e0;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
        }

        /* --- Reset e Base --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-secondary);
            line-height: 1.6;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Header Moderno --- */
        .header {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: white;
            padding: 0;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: white;
            font-weight: 700;
            font-size: 20px;
            letter-spacing: -0.025em;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-gradient);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }

        .logout-btn {
            color: #a0aec0;
            text-decoration: none;
            font-size: 13px;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .logout-btn:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* --- Container Principal --- */
        .main-content {
            flex: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 32px;
            width: 100%;
        }

        /* --- Título Principal --- */
        .page-header {
            margin-bottom: 48px;
            text-align: center;
        }

        .page-title {
            font-size: 36px;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -0.025em;
        }

        .page-subtitle {
            font-size: 16px;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* --- Seção de Nova Ordem --- */
        .create-order-section {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 32px;
            margin-bottom: 48px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }

        .create-order-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .section-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.025em;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--bg-card);
            transition: all 0.2s ease;
            outline: none;
        }

        .form-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: var(--radius-lg);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-md);
            letter-spacing: -0.025em;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        /* --- Resultado da Ordem --- */
        .order-result {
            margin-top: 24px;
            padding: 20px 24px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            border-radius: var(--radius-lg);
            color: white;
            display: none;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .order-result-text {
            font-weight: 600;
            font-size: 14px;
        }

        .order-link {
            color: white;
            word-break: break-all;
            text-decoration: underline;
            font-weight: 500;
        }

        .btn-copy {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            backdrop-filter: blur(10px);
        }

        .btn-copy:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* --- Cards de Métricas --- */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 48px;
        }

        .metric-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 28px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
        }

        .metric-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .metric-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }

        .metric-subtitle {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* --- Seções de Conteúdo --- */
        .content-section {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
        }

        /* --- Grid de Gráficos --- */
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 32px;
            margin-bottom: 32px;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 28px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            position: relative;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
            letter-spacing: -0.025em;
        }

        .chart-wrapper {
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Tabela Moderna --- */
        .table-container {
            overflow: hidden;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-light);
            background: var(--bg-card);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .table th {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            color: var(--text-primary);
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 20px 24px;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .table td {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        /* --- Status Badges --- */
        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            min-width: 90px;
        }

        .status-badge.fresh {
            background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
            color: white;
        }

        .status-badge.progress {
            background: linear-gradient(135deg, #ed8936 0%, #c05621 100%);
            color: white;
        }

        .status-badge.paid {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        /* --- Payer IDs --- */
        .payer-ids {
            font-size: 12px;
            color: var(--text-muted);
            font-family: 'Courier New', monospace;
            background: var(--bg-secondary);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            display: inline-block;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .payer-ids:empty:before {
            content: "Sem pagadores";
            color: var(--text-muted);
            font-style: italic;
        }

        /* --- Footer --- */
        .footer {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: #a0aec0;
            text-align: center;
            padding: 32px;
            margin-top: 48px;
            font-size: 13px;
        }

        .footer a {
            color: var(--primary-color);
            text-decoration: none;
            margin: 0 12px;
            font-weight: 500;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* --- Responsividade --- */
        @media (max-width: 1024px) {
            .main-content {
                padding: 32px 24px;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
                gap: 24px;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                padding: 16px 24px;
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            .main-content {
                padding: 24px 16px;
            }
            
            .page-title {
                font-size: 28px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .metric-value {
                font-size: 28px;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            .table {
                min-width: 600px;
            }
            
            .create-order-section,
            .content-section,
            .chart-card {
                padding: 24px;
            }
        }

        @media (max-width: 480px) {
            .order-result {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .btn-copy {
                margin-top: 12px;
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">
                <div class="logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span>PagJunto</span>
            </a>
            <div class="user-section">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <span>Olá, <% if (typeof partnerData.partnerName !== 'undefined') { %><%= partnerData.partnerName %><% } else { %>Parceiro<% } %></span>
                </div>
                <a href="/logout" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </a>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">Dashboard Executivo</h1>
            <p class="page-subtitle">Visão completa do desempenho da sua conta corporativa</p>
        </div>

        <section class="create-order-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-plus"></i>
                </div>
                <h2 class="section-title">Criar Nova Ordem</h2>
            </div>
            <form id="newOrderForm">
                <div class="form-group">
                    <label for="totalValue" class="form-label">Valor Total da Ordem</label>
                    <input type="number" id="totalValue" name="totalValue" class="form-input" step="0.01" min="0.01" required placeholder="Ex: 150.00">
                </div>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-plus"></i>
                    Gerar Ordem de Pagamento
                </button>
            </form>
            <div id="orderCreationResult" class="order-result">
                <div>
                    <p class="order-result-text">Link da Ordem Criada:</p>
                    <a id="orderLink" href="#" target="_blank" class="order-link"></a>
                </div>
                <button id="copyLinkButton" class="btn-copy">
                    <i class="fas fa-copy"></i> Copiar
                </button>
            </div>
        </section>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">Saldo da Conta</span>
                    <div class="metric-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                </div>
                <div class="metric-value">R$ <% if (typeof summary !== 'undefined' && summary.accountBalance !== undefined) { %><%= summary.accountBalance.toFixed(2) %><% } else { %>15.234,56<% } %></div>
                <div class="metric-subtitle">Disponível para saque</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">Vendas Totais</span>
                    <div class="metric-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="metric-value">R$ <% if (typeof summary !== 'undefined' && summary.totalSales !== undefined) { %><%= summary.totalSales.toFixed(2) %><% } else { %>87.654,32<% } %></div>
                <div class="metric-subtitle">Valor bruto de todas as ordens</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">Valor Recebido</span>
                    <div class="metric-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                </div>
                <div class="metric-value">R$ <% if (typeof summary !== 'undefined' && summary.totalPaidValue !== undefined) { %><%= summary.totalPaidValue.toFixed(2) %><% } else { %>72.110,00<% } %></div>
                <div class="metric-subtitle">Valor já pago pelos clientes</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">Total de Ordens</span>
                    <div class="metric-icon">
                        <i class="fas fa-box"></i>
                    </div>
                </div>
                <div class="metric-value"><% if (typeof summary !== 'undefined' && summary.totalOrders !== undefined) { %><%= summary.totalOrders %><% } else { %>458<% } %></div>
                <div class="metric-subtitle">Total de ordens geradas</div>
            </div>
            
            <div class="metric-card">
                <div class="metric-header">
                    <span class="metric-title">Em Progresso</span>
                    <div class="metric-icon">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                </div>
                <div class="metric-value"><% if (typeof summary !== 'undefined' && summary.progressOrders !== undefined) { %><%= summary.progressOrders %><% } else { %>35<% } %></div>
                <div class="metric-subtitle">Aguardando pagamento</div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card">
                <h3 class="chart-title">Tendência de Vendas Mensais</h3>
                <div class="chart-wrapper">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
            <div class="chart-card">
                <h3 class="chart-title">Status das Ordens</h3>
                <div class="chart-wrapper">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>

        <section class="content-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-list-alt"></i>
                </div>
                <h2 class="section-title">Ordens Recentes</h2>
            </div>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID da Ordem</th>
                            <th>Valor Total</th>
                            <th>Valor Pago</th>
                            <th>Status</th>
                            <th>Pagadores</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (typeof orders !== 'undefined' && orders.length > 0) { %>
                            <% orders.forEach(order => { %>
                                <tr>
                                    <td><%= order.orderId %></td>
                                    <td>R$ <%= order.totalValue.toFixed(2) %></td>
                                    <td>R$ <%= order.paidValue.toFixed(2) %></td>
                                    <td><span class="status-badge <%= order.status %>"><%= order.status %></span></td>
                                    <td>
                                        <span class="payer-ids">
                                            <% if (order.payerIds && order.payerIds.length > 0) { %>
                                                <%= order.payerIds.join(', ') %>
                                            <% } %>
                                        </span>
                                    </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr><td>ORD-20250628-001</td><td>R$ 150,00</td><td>R$ 0,00</td><td><span class="status-badge fresh">Fresh</span></td><td><span class="payer-ids"></span></td></tr>
                            <tr><td>ORD-20250628-002</td><td>R$ 320,50</td><td>R$ 160,25</td><td><span class="status-badge progress">Progress</span></td><td><span class="payer-ids">payer_xyz, payer_abc</span></td></tr>
                            <tr><td>ORD-20250627-015</td><td>R$ 55,90</td><td>R$ 55,90</td><td><span class="status-badge paid">Paid</span></td><td><span class="payer-ids">payer_123</span></td></tr>
                            <tr><td>ORD-20250627-014</td><td>R$ 890,00</td><td>R$ 0,00</td><td><span class="status-badge fresh">Fresh</span></td><td><span class="payer-ids"></span></td></tr>
                            <tr><td>ORD-20250626-003</td><td>R$ 250,00</td><td>R$ 250,00</td><td><span class="status-badge paid">Paid</span></td><td><span class="payer-ids">payer_456</span></td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer class="footer">
        <p>&copy; <%= new Date().getFullYear() %> PagJunto. Todos os direitos reservados. | <a href="#">Política de Privacidade</a> | <a href="#">Termos de Serviço</a></p>
    </footer>

<script>
// --- Dados Mockados (para testar sem backend) ---
const mockSalesLabels = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul'];
const mockSalesData = [8500, 11000, 9800, 14200, 13000, 17500, 19000];

// Os dados do gráfico de status devem vir de 'statusCounts', não 'statusData'
// 'statusCounts' é preenchido pelo EJS com dados do backend ou com mockStatusData
const mockStatusData = {
    fresh: 150,
    progress: 70,
    paid: 238
};

// --- Variáveis injetadas pelo EJS (use estas quando tiver dados do backend) ---
// Certifique-se de que estas variáveis globais sejam definidas no seu EJS antes do script,
// ou que seus valores sejam obtidos do DOM se forem embutidos como atributos.
// Exemplo no EJS:
// <script>
//    const partnerId = "<%= typeof partnerId !== 'undefined' ? partnerId : 'mockPartner123' %>";
//    const partnerApiKey = "<%= typeof partnerApiKey !== 'undefined' ? partnerApiKey : 'mockApiKeyXYZ' %>";
//    // ... demais variáveis
// 

// Garante que as variáveis existam e sejam arrays/objetos válidos, mesmo que vazios
const salesLabels = typeof salesLabelsForChart !== 'undefined' && salesLabelsForChart.length > 0 ?
                      salesLabelsForChart : mockSalesLabels;

const salesData = typeof salesDataForChart !== 'undefined' && salesDataForChart.length > 0 ?
                    salesDataForChart : mockSalesData;

const statusCounts = {
    fresh: typeof summary !== 'undefined' && summary.freshOrders !== undefined ? summary.freshOrders : mockStatusData.fresh,
    progress: typeof summary !== 'undefined' && summary.progressOrders !== undefined ? summary.progressOrders : mockStatusData.progress,
    paid: typeof summary !== 'undefined' && summary.paidOrders !== undefined ? summary.paidOrders : mockStatusData.paid
};


// Helper para obter variáveis CSS no JS (Mantenha esta função)
function var_to_css_var(variable) {
    return getComputedStyle(document.documentElement).getPropertyValue(variable);
}

// --- Gráfico de Vendas Mensais (Line Chart) ---
// Certifique-se de que 'salesChart' existe no seu HTML
const salesCtx = document.getElementById('salesChart').getContext('2d');
const salesChart = new Chart(salesCtx, {
    type: 'line',
    data: {
        labels: salesLabels,
        datasets: [{
            label: 'Vendas Totais (R$)',
            data: salesData,
            borderColor: var_to_css_var('--primary-color'),
            backgroundColor: 'rgba(0, 86, 179, 0.1)', /* Variação da cor primária */
            tension: 0.4,
            fill: true,
            pointBackgroundColor: var_to_css_var('--primary-color'),
            pointBorderColor: '#fff',
            pointHoverRadius: 6,
            pointHoverBorderColor: var_to_css_var('--primary-color')
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
                labels: { font: { family: 'Inter' } }
            },
            title: {
                display: true,
                text: 'Tendência de Vendas Mensais',
                font: { size: 18, family: 'Inter', weight: '600' },
                color: var_to_css_var('--text-dark')
            },
            tooltip: {
                titleFont: { family: 'Inter' },
                bodyFont: { family: 'Inter' },
                callbacks: {
                    label: function(context) {
                        return ` ${context.dataset.label}: R$ ${context.parsed.y.toFixed(2)}`;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: { color: var_to_css_var('--border-color') },
                ticks: {
                    font: { family: 'Inter' },
                    callback: function(value, index, values) {
                        return 'R$ ' + value.toLocaleString('pt-BR');
                    }
                }
            },
            x: {
                grid: { display: false },
                ticks: { font: { family: 'Inter' } }
            }
        }
    }
});


// --- Gráfico de Status de Pedidos (Doughnut Chart) ---
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut', // Alterado para doughnut
    data: {
        labels: ['Novas', 'Em Progresso', 'Pagas'],
        datasets: [{
            // Use statusCounts aqui, que já pega os dados do EJS ou os mocks
            data: [statusCounts.fresh, statusCounts.progress, statusCounts.paid],
            backgroundColor: [
                '#007bff', // Cor para Fresh (azul) - correspondente ao CSS
                '#ffc107', // Cor para Progress (amarelo) - correspondente ao CSS
                '#28a745'  // Cor para Paid (verde) - correspondente ao CSS
            ],
            borderWidth: 0,
            hoverBorderWidth: 3,
            hoverBorderColor: '#ffffff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%', // Tamanho do buraco no meio do doughnut
        plugins: {
            legend: {
                position: 'bottom', // Legenda abaixo do gráfico
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    pointStyle: 'circle', // Bolinhas como indicadores na legenda
                    font: {
                        size: 13,
                        weight: '600'
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(26, 32, 44, 0.9)', // Fundo escuro para tooltip
                titleColor: '#ffffff',
                bodyColor: '#ffffff',
                borderColor: '#667eea',
                borderWidth: 1,
                cornerRadius: 8,
                callbacks: {
                    label: function(context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                        return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                    }
                }
            }
        }
    }
});


// --- Formulário de Nova Ordem ---
document.getElementById('newOrderForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const totalValue = document.getElementById('totalValue').value;
    const submitButton = e.target.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML; // Guarde o HTML original do botão
    const orderCreationResult = document.getElementById('orderCreationResult');
    const orderLinkElement = document.getElementById('orderLink');

    // Validação básica do valor
    if (isNaN(parseFloat(totalValue)) || parseFloat(totalValue) <= 0) {
        alert('Por favor, insira um Valor Total válido (número maior que zero).');
        return;
    }

    // Carregando estado do botão
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';
    submitButton.disabled = true;

    // Garante que partnerId e partnerApiKey estão disponíveis
    // Se eles vêm do backend via EJS, certifique-se de que estão no escopo global ou passados via data attributes
    const localPartnerId = "<%= partnerData.partnerId %>"
    const localPartnerApiKey = "<%= partnerData.apiKey %>"

    try {
        const response = await fetch('http://localhost:3000/order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                partnerId: localPartnerId, // Usando a variável local
                totalValue: totalValue, // Converte para float para enviar
                apiKey: localPartnerApiKey // Usando a variável local
            })
        });

        // Verifica se a resposta HTTP é OK antes de tentar ler o JSON
        if (!response.ok) {
            // Tenta ler o erro do corpo da resposta, se disponível
            const errorData = await response.json().catch(() => ({ message: 'Erro desconhecido.' }));
            throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
        }

        const result = await response.json();

        // O backend retorna apenas o orderId, então construímos a URL completa aqui
        if (result) {
            const generatedOrderLink = `http://localhost/${localPartnerId}/${result}`; // Construa a URL completa

            orderLinkElement.href = generatedOrderLink;
            orderLinkElement.textContent = generatedOrderLink;
            orderCreationResult.style.display = 'flex'; // Exibe o resultado

            // Limpar formulário
            document.getElementById('totalValue').value = '';

            // Scroll para o resultado
            orderCreationResult.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Ajuste para melhor visualização

            alert('Ordem criada com sucesso! Link gerado: ' + generatedOrderLink);

            // Opcional: Atualizar a lista de ordens ou os dados dos gráficos aqui
            // updateDashboardData(); // Se você tiver essa função implementada
            
        } else {
            // Se a resposta não contiver orderId, é um erro
            throw new Error('Resposta inválida do servidor: Order ID não encontrado.');
        }

    } catch (error) {
        console.error('Erro ao criar ordem:', error);
        alert('Erro ao criar ordem: ' + error.message);
    } finally {
        // Restaurar botão
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    }
});

// --- Botão de Copiar Link ---
document.getElementById('copyLinkButton').addEventListener('click', function() {
    const orderLink = document.getElementById('orderLink');
    const copyButton = this;
    const originalText = copyButton.innerHTML; // Salva o estado original do botão

    if (!orderLink.href || orderLink.href === '#') {
        alert('Nenhum link para copiar. Crie uma ordem primeiro.');
        return;
    }

    // Copiar para clipboard
    navigator.clipboard.writeText(orderLink.href)
        .then(() => {
            // Feedback visual de sucesso
            copyButton.innerHTML = '<i class="fas fa-check"></i> Copiado!';
            copyButton.style.backgroundColor = '#28a745'; // Verde de sucesso
            copyButton.style.color = '#ffffff';

            setTimeout(() => {
                // Restaurar estado original
                copyButton.innerHTML = originalText;
                // Restaurar cor de fundo para a cor padrão definida no CSS
                copyButton.style.backgroundColor = var_to_css_var('--secondary-color');
                copyButton.style.color = '#ffffff'; // Garante que o texto volte a ser branco
            }, 2000);
        })
        .catch(err => {
            console.error('Erro ao copiar:', err);
            // Fallback para navegadores mais antigos (usando execCommand)
            const textArea = document.createElement('textarea');
            textArea.value = orderLink.href;
            textArea.style.position = 'fixed'; // Evita que a textarea afete o layout
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.opacity = '0'; // Torna invisível
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                // Feedback visual de sucesso para o fallback
                copyButton.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                copyButton.style.backgroundColor = '#28a745';
                copyButton.style.color = '#ffffff';
                setTimeout(() => {
                    copyButton.innerHTML = originalText;
                    copyButton.style.backgroundColor = var_to_css_var('--secondary-color');
                    copyButton.style.color = '#ffffff';
                }, 2000);
            } catch (copyErr) {
                console.error('Falha ao copiar usando execCommand:', copyErr);
                alert('Erro ao copiar o link. Por favor, copie-o manualmente: ' + orderLink.href);
            } finally {
                document.body.removeChild(textArea);
            }
        });
});


document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard PagJunto Corporate carregado');

    const cards = document.querySelectorAll('.summary-cards .card, .section');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';

        setTimeout(() => {
            card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 80); 
    });

    document.getElementById('orderCreationResult').style.display = 'none';
});

// --- Utilitários (Mantenha estas funções se as usar no EJS para exibir os dados) ---
function formatCurrency(value) {
    if (typeof value !== 'number') return 'R$ 0,00'; // Fallback
    return value.toLocaleString('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    });
}

function formatNumber(value) {
    if (typeof value !== 'number') return '0'; // Fallback
    return value.toLocaleString('pt-BR');
}

// --- Responsividade para gráficos (Mantenha esta parte) ---
window.addEventListener('resize', function() {
    if (salesChart) salesChart.resize();
    if (statusChart) statusChart.resize();
});

</script>