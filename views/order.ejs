<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pagamento Seguro - Pagjunto</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
<script src="<%=process.env.API_SITE_URL%>/socket.io/socket.io.js"></script>    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --primary-light: #dbeafe;
            --accent: #059669; /* Verde para sucesso */
            --accent-light: #d1fae5;
            --accent-hover: #a7f3d0;
            --error: #dc2626;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --text-header: #0f172a;
            --text-body: #374151;
            --text-muted: #6b7280;
            --border: #e2e8f0;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 32px rgba(37, 99, 235, 0.12);
            --radius: 12px;
            --radius-lg: 20px;
            --gradient-primary: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            --gradient-accent: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            --gradient-card: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.9) 100%);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-body);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
            overflow-x: hidden;
        }
        .bg-decoration {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.6;
        }
        .bg-circle {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(96, 165, 250, 0.05));
            animation: float 20s ease-in-out infinite;
        }
        .bg-circle:nth-child(1) { width: 300px; height: 300px; top: 10%; left: -150px; }
        .bg-circle:nth-child(2) { width: 200px; height: 200px; top: 60%; right: -100px; animation-delay: -7s; }
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-30px) rotate(180deg); }
        }
        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 24px;
            position: relative;
            z-index: 1;
        }
        header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header .logo {
            font-weight: 700;
            font-size: 24px;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        header .logo:hover {
            opacity: 0.8;
        }
        header .secure-badge {
            font-size: 14px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        header .secure-badge i {
            color: var(--accent);
        }
        main {
            padding: 60px 0;
            display: flex;
            gap: 40px;
            flex-wrap: wrap;
            align-items: flex-start;
        }
        .card {
            margin-top: 50px;
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            padding: 30px 35px;
            flex: 1;
            min-width: 350px;
            transition: all 0.3s ease;
            position: relative;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-header);
        }
        .section-title i {
            color: var(--primary);
        }
        .paid-flag {
            margin-left: auto;
            background-color: var(--accent-light);
            color: var(--accent);
            padding: 5px 12px;
            border-radius: 999px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .copy-link-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-muted);
            width: 36px;
            height: 36px;
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .card-header-actions {
            margin-left: auto;
            display: flex;
            gap: 10px;
        }
        .copy-link-btn:hover {
            background: var(--bg-secondary);
            color: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        .copy-link-btn.copied {
            color: var(--accent);
            border-color: var(--accent);
            background-color: var(--accent-light);
        }
        .copy-link-btn:disabled {
            cursor: default;
        }
        .paid-card-message {
            text-align: center;
            padding: 40px 20px;
        }
        .paid-card-message .section-title {
            justify-content: center;
            font-size: 22px;
        }
        .paid-card-message p {
            font-size: 16px;
            color: var(--text-muted);
            margin-top: -15px;
        }
        .info-group {
            margin-bottom: 20px;
        }
        .info-group label {
            display: block;
            font-weight: 500;
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 6px;
        }
        .info-group .value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-header);
        }
        .info-group .value.primary {
            color: var(--primary);
        }
        .info-group .value.paid {
            color: var(--accent);
        }
        .progress-container {
            margin-top: 25px;
        }
        .progress-container label {
            display: block;
            font-weight: 500;
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 8px;
        }
        .progress {
            background-color: #e2e8f0;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: <%= (orderData.paidValue >= orderData.totalValue) ? 'var(--accent)' : 'var(--primary)' %>;
            width: <%= (orderData.paidValue / orderData.totalValue) * 100 %>%;
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out; /* ATUALIZA√á√ÉO: Adicionado transition para cor */
            border-radius: 6px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 15px;
            color: var(--text-body);
        }
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 16px;
            font-size: 1rem;
            color: var(--text-body);
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), var(--bg-secondary));
            border: 1px solid var(--border);
            border-radius: var(--radius);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
        }
        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
            background-color: var(--bg-primary);
        }
        .error-message {
            color: var(--error);
            font-size: 14px;
            margin-top: -10px;
            margin-bottom: 15px;
            height: 25px;
        }
        .btn {
            background: var(--gradient-accent);
            color: white;
            font-size: 16px;
            padding: 16px;
            width: 100%;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 5px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.2);
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(37, 99, 235, 0.3);
        }
        .btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .loader {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .qr-container {
            text-align: center;
            margin-top: 30px;
            padding-top: 25px;
            border-top: 1px dashed var(--border);
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.5s ease, transform 0.5s ease;
            display: none;
        }
        .qr-container.visible {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        .qr-container img {
            max-width: 200px;
            margin: 10px auto 15px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
        }
        .pix-key-wrapper {
            display: flex;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 4px;
            margin-top: 15px;
            align-items: center;
        }
        .pix-key-wrapper input {
            flex-grow: 1;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 14px;
            outline: none;
            padding: 8px;
        }
        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: background-color 0.2s, transform 0.2s;
        }
        .copy-btn:hover {
            background-color: var(--primary-hover);
            transform: scale(1.05);
        }
        footer {
            text-align: center;
            padding: 40px 0;
            font-size: 14px;
            color: var(--text-muted);
            border-top: 1px solid var(--border);
            margin-top: 60px;
        }
        .footer-content i {
            color: var(--accent);
            margin-right: 5px;
        }
        footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }
        footer a:hover {
            text-decoration: underline;
        }
        .terms-consent {
            margin-bottom: 20px;
            padding: 12px;
            background-color: var(--primary-light);
            border-radius: var(--radius);
            border: 1px solid rgba(37, 99, 235, 0.2);
        }
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        .checkbox-container input[type="checkbox"] {
            margin-top: 3px;
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
            cursor: pointer;
            flex-shrink: 0;
        }
        .checkbox-label {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-body);
            cursor: pointer;
        }
        .terms-link {
            color: var(--primary);
            text-decoration: underline;
            cursor: pointer;
            font-weight: 600;
        }
        .terms-link:hover {
            color: var(--primary-hover);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: var(--bg-primary);
            margin: 20px;
            padding: 0;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            position: relative;
            animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .modal-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-header);
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, color 0.2s;
        }
        .close-btn:hover {
            background-color: var(--bg-secondary);
            color: var(--text-body);
        }
        .modal-body {
            line-height: 1.6;
            color: var(--text-body);
            padding: 25px 30px;
            overflow-y: auto;
        }
        .modal-body.centered { text-align: center; }
        #pageQrcodeContainer { display: flex; justify-content: center; align-items: center; margin: 20px 0; }
        .modal-body h3 {
            color: var(--text-header);
            font-size: 18px;
            font-weight: 600;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        .modal-body h3:first-child { margin-top: 0; }
        .modal-body p { margin-bottom: 15px; }
        .modal-body ul { margin-bottom: 15px; padding-left: 20px; }
        .modal-body li { margin-bottom: 8px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @media (max-width: 900px) {
            main { flex-direction: column; }
            .card {
                padding: 25px;
            }
            .modal-content { margin: 10px; padding: 0; }
            .modal-header, .modal-body { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="bg-decoration">
        <div class="bg-circle"></div>
        <div class="bg-circle"></div>
    </div>

    <header>
        <div class="container header-content">
            <div class="logo" onclick="window.location.href='/'">pagjunto</div>
            <div class="secure-badge">
                <i class="fas fa-lock"></i> Pagamento Seguro
            </div>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <div class="section-title" id="summaryCardTitle">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>Cobran√ßa de <%= partnerData.partnerName %></span>
                <div class="card-header-actions">
                    <button class="copy-link-btn" id="copyLinkBtn" title="Copiar link da cobran√ßa">
                        <i class="fas fa-link"></i>
                    </button>
                    <button class="copy-link-btn" id="showQrBtn" title="Mostrar QR Code do link">
                        <i class="fas fa-qrcode"></i>
                    </button>
                </div>
                <% if (orderData.paidValue >= orderData.totalValue) { %>
                    <span class="paid-flag">
                        <i class="fas fa-check-circle"></i> PAGO
                    </span>
                <% } %>
            </div>
            <div class="info-group">
                <label>Valor total</label>
                <span class="value">R$ <%= orderData.totalValue.toFixed(2).replace('.', ',') %></span>
            </div>
            <div class="info-group">
                <label>Valor j√° pago</label>
                <span id="paidValueSpan" class="value <%= (orderData.paidValue >= orderData.totalValue) ? 'paid' : 'primary' %>">R$ <%= orderData.paidValue.toFixed(2).replace('.', ',') %></span>
            </div>
            <div class="info-group">
                <label>Pagamentos recebidos</label>
                <span id="paymentsNumberSpan" class="value"><%= orderData.paymentsNumber %></span>
            </div>
            <div class="progress-container">
                <label>Progresso do Pagamento</label>
                <div class="progress">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
            </div>
        </div>

        <% if (orderData.paidValue >= orderData.totalValue) { %>
        <div class="card paid-card-message">
            <div class="section-title">
                <i class="fas fa-check-circle" style="color: var(--accent);"></i>
                Cobran√ßa Finalizada
            </div>
            <p>Este pagamento j√° foi totalmente finalizado. Obrigado!</p>
        </div>
        <% } else { %>
        <div class="card" id="paymentCard">
            <div class="section-title"><i class="fas fa-qrcode"></i> Pague com Pix</div>
            <form id="paymentForm" novalidate>
                <div class="form-group">
                    <label for="name">Seu nome completo</label>
                    <input type="text" id="name" placeholder="Digite seu nome completo" required />
                </div>
                <div class="form-group">
                    <label for="cpf">Seu CPF (para identifica√ß√£o)</label>
                    <input type="text" id="cpf" placeholder="000.000.000-00" required />
                </div>
                <div class="form-group">
                    <label for="phone">Seu telefone (com DDD)</label>
                    <input type="text" id="phone" placeholder="(99) 99999-9999" required />
                </div>
                <div class="form-group">
                    <label for="valor">Valor a pagar</label>
                    <input type="text" id="valor" placeholder="Ex: 50,00" inputmode="decimal" required />
                </div>
                <div class="terms-consent">
                    <div class="checkbox-container">
                        <input type="checkbox" id="termsCheckbox" required />
                        <label for="termsCheckbox" class="checkbox-label">
                            Concordo com os <span class="terms-link" id="openTermsModal">Termos e Condi√ß√µes de Uso.</span>
                        </label>
                    </div>
                </div>
                <div id="errorMessage" class="error-message"></div>
                <button type="submit" id="generateBtn" class="btn">
                    <span id="btnText">Gerar QR Code Pix</span>
                    <div id="loader" class="loader" style="display: none;"></div>
                </button>
            </form>
            <div class="qr-container" id="qrBox">
                <p><strong>Tudo pronto!</strong> Escaneie o c√≥digo abaixo para pagar:</p>
                <img src="" alt="QR Code Pix" />
                <p>Ou copie a chave Pix:</p>
                <div class="pix-key-wrapper">
                    <input type="text" readonly id="pixKey" value="" />
                    <button class="copy-btn" id="copyBtn">Copiar</button>
                </div>
            </div>
        </div>
        <% } %>
    </main>

    <div id="termsModal" class="modal">
    </div>
    
    <div id="pageQrModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2 class="modal-title">Compartilhar Link da Cobran√ßa</h2>
                <button id="closeQrModal" class="close-btn">&times;</button>
            </div>
            <div class="modal-body centered">
                <p>Escaneie para abrir esta p√°gina em outro dispositivo.</p>
                <div id="pageQrcodeContainer"></div>
                <p style="margin-top: 15px; font-size: 14px; word-break: break-all;">Ou copie o link:</p>
                <div class="pix-key-wrapper" style="max-width: 400px; margin: 10px auto 0;">
                    <input type="text" readonly id="pageQrLinkText" value="" />
                    <button class="copy-btn" id="copyPageLinkBtn">Copiar</button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="container footer-content">
            <p><i class="fas fa-shield-alt"></i>Conex√£o Segura. ¬© 2025 Pagjunto ‚Äî D√∫vidas? <a href="mailto:suporte@pagjunto.com">suporte@pagjunto.com</a></p>
        </div>
    </footer>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', function () {

    function getLastIdsFromCurrentUrl() {
        const parts = window.location.href.split("/").filter(Boolean);
        const id2 = parts[parts.length - 1];
        return { id2 };
    }

    const copyLinkBtn = document.getElementById('copyLinkBtn');
    if (copyLinkBtn) {
        copyLinkBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href).then(() => {
                const originalIcon = copyLinkBtn.innerHTML;
                copyLinkBtn.innerHTML = '<i class="fas fa-check"></i>';
                copyLinkBtn.classList.add('copied');
                copyLinkBtn.disabled = true;

                setTimeout(() => {
                    copyLinkBtn.innerHTML = originalIcon;
                    copyLinkBtn.classList.remove('copied');
                    copyLinkBtn.disabled = false;
                }, 2000);
            }).catch(err => {
                console.error('Falha ao copiar o link: ', err);
                alert('N√£o foi poss√≠vel copiar o link.');
            });
        });
    }

    const showQrBtn = document.getElementById('showQrBtn');
    const pageQrModal = document.getElementById('pageQrModal');
    const closeQrModalBtn = document.getElementById('closeQrModal');
    const pageQrcodeContainer = document.getElementById('pageQrcodeContainer');
    const pageQrLinkText = document.getElementById('pageQrLinkText');
    const copyPageLinkBtn = document.getElementById('copyPageLinkBtn');

    if (showQrBtn) {
        showQrBtn.addEventListener('click', () => {
            const pageUrl = window.location.href;
            pageQrcodeContainer.innerHTML = '';
            new QRCode(pageQrcodeContainer, {
                text: pageUrl, width: 256, height: 256,
                colorDark: "#000000", colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            pageQrLinkText.value = pageUrl;
            pageQrModal.classList.add('show');
            document.body.style.overflow = 'hidden';
        });
    }

    if (closeQrModalBtn) {
        closeQrModalBtn.addEventListener('click', () => {
            pageQrModal.classList.remove('show');
            document.body.style.overflow = 'auto';
        });
    }

    if (copyPageLinkBtn) {
        copyPageLinkBtn.addEventListener('click', () => {
             navigator.clipboard.writeText(pageQrLinkText.value).then(() => {
                 copyPageLinkBtn.textContent = 'Copiado!';
                 setTimeout(() => { copyPageLinkBtn.textContent = 'Copiar'; }, 2000);
            });
        });
    }
    
    [pageQrModal, document.getElementById('termsModal')].forEach(modal => {
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                    document.body.style.overflow = 'auto';
                }
            });
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal.show').forEach(modal => {
                modal.classList.remove('show');
            });
            document.body.style.overflow = 'auto';
        }
    });
    
    let socket;
    function initializeSocket() {
        try {
            const { id2 } = getLastIdsFromCurrentUrl();
            socket = io("<%=process.env.API_SITE_URL%>", { transports: ['websocket', 'polling'] });

            socket.on('connect', () => {
                console.log('‚úÖ Conectado ao WebSocket. Socket ID:', socket.id);
                socket.emit('joinRoom', id2);
            });

            socket.on('disconnect', (reason) => console.log('‚ùå Desconectado do WebSocket. Motivo:', reason));
            socket.on('connect_error', (err) => console.error('‚ùå Falha na conex√£o com o WebSocket:', err.message));

            socket.on('paymentConfirmed', (data) => {
                console.log('üéâ Evento de confirma√ß√£o de pagamento recebido:', data);

                try {
                    const paymentCard = document.getElementById('paymentCard');

                    if (paymentCard) {
                        const paidAmount = (data && typeof data.paidValue === 'number') ? data.paidValue.toFixed(2).replace('.', ',') : 'um valor';
                        const payer = (data && data.payerName) ? `de <strong>${data.payerName}</strong>` : '';

                        paymentCard.innerHTML = `
                            <div class="paid-card-message">
                                <div class="section-title">
                                    <i class="fas fa-check-circle" style="color: var(--accent);"></i>
                                    Pagamento Recebido!
                                </div>
                                <p>O pagamento de <strong>R$ ${paidAmount}</strong> ${payer} foi confirmado com sucesso.</p>
                                <p style="font-size: 14px; margin-top: 10px;">Aguarde, a p√°gina ser√° atualizada para refletir o novo saldo.</p>
                            </div>`;
                    }
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);

                } catch (error) {
                    console.error('‚ùå Erro ao processar o evento de pagamento. Recarregando a p√°gina como seguran√ßa.', error);
                    window.location.reload();
                }
            });

        } catch (error) {
            console.error("‚ùå Erro ao inicializar Socket.IO:", error);
        }
    }

    initializeSocket();

    if (document.getElementById('paymentForm')) {
        const paymentForm = document.getElementById('paymentForm');
        const nameInput = document.getElementById('name');
        const cpfInput = document.getElementById('cpf');
        const phoneInput = document.getElementById('phone'); // Pega o novo campo
        const valueInput = document.getElementById('valor');
        const generateBtn = document.getElementById('generateBtn');
        const btnText = document.getElementById('btnText');
        const loader = document.getElementById('loader');
        const qrBox = document.getElementById('qrBox');
        const errorMessage = document.getElementById('errorMessage');
        const copyBtn = document.getElementById('copyBtn');
        const pixKeyInput = document.getElementById('pixKey');
        const termsCheckbox = document.getElementById('termsCheckbox');

        cpfInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '').slice(0, 11);
            value = value.replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
            e.target.value = value;
        });

        // Adiciona a m√°scara para o campo de telefone
        phoneInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '').slice(0, 11);
            if (value.length > 10) {
                value = value.replace(/^(\d\d)(\d{5})(\d{4}).*/, '($1) $2-$3');
            } else if (value.length > 5) {
                value = value.replace(/^(\d\d)(\d{4})(\d{0,4}).*/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d\d)(\d{0,5}).*/, '($1) $2');
            } else {
                value = value.replace(/^(\d*)/, '($1');
            }
            e.target.value = value;
        });

        paymentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            gerarPix();
        });
        
        async function gerarPix() {
            errorMessage.textContent = '';
            const fullName = nameInput.value.trim();
            const valorString = valueInput.value.replace(',', '.');
            const valorFloat = parseFloat(valorString);
            const cpf = cpfInput.value;
            const phone = phoneInput.value;
            const rawPhone = phone.replace(/\D/g, ''); // Telefone sem m√°scara

            const totalValue = <%= orderData.totalValue %>;
            const paidValue = <%= orderData.paidValue %>;
            const remainingValue = totalValue - paidValue;
            
            if (!fullName || fullName.split(' ').length < 2) { return errorMessage.textContent = "Informe seu nome completo."; }
            if (cpf.length !== 14) { return errorMessage.textContent = "Informe um CPF v√°lido."; }
            if (rawPhone.length < 10 || rawPhone.length > 11) { return errorMessage.textContent = "Informe um telefone v√°lido com DDD."; }
            if (isNaN(valorFloat) || valorFloat <= 0) { return errorMessage.textContent = "Insira um valor de pagamento v√°lido."; }
            if (valorFloat > remainingValue + 0.001) {
                 return errorMessage.textContent = `O valor excede o restante (R$ ${remainingValue.toFixed(2).replace('.',',')}).`;
            }
            if (!termsCheckbox.checked) { return errorMessage.textContent = "Voc√™ deve concordar com os Termos."; }
            
            generateBtn.disabled = true;
            btnText.style.display = 'none';
            loader.style.display = 'block';

            try {
                const { id2 } = getLastIdsFromCurrentUrl();
                const response = await fetch(`<%=process.env.API_SITE_URL%>/payment/create-pix`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: fullName, // Enviando nome completo
                        cpf: cpf.replace(/\D/g, ''),
                        phone: { // Enviando o telefone de forma estruturada
                            country_code: '55',
                            area_code: rawPhone.substring(0, 2),
                            number: rawPhone.substring(2)
                        },
                        amount: Math.round(valorFloat * 100),
                        recipient_id: "<%=partnerData.recipient_id%>",
                        orderId: id2
                    })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Erro desconhecido.');

                btnText.textContent = "QR Code Gerado!";
                generateBtn.style.background = 'var(--accent)';
                document.querySelector('#qrBox img').src = data.data.last_transaction.qr_code_url;
                pixKeyInput.value = data.data.last_transaction.qr_code;
                qrBox.classList.add('visible');
                qrBox.scrollIntoView({ behavior: 'smooth', block: 'center' });

            } catch (error) {
                errorMessage.textContent = `Erro: ${error.message}`;
                generateBtn.disabled = false;
                btnText.textContent = 'Gerar QR Code Pix';
            } finally {
                btnText.style.display = 'inline';
                loader.style.display = 'none';
            }
        }
        
        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(pixKeyInput.value).then(() => {
                copyBtn.textContent = 'Copiado!';
                setTimeout(() => { copyBtn.textContent = 'Copiar'; }, 2000);
            });
        });
    }

    window.addEventListener('beforeunload', () => {
        if (socket) socket.disconnect();
    });
});
    </script>
</body>
</html>